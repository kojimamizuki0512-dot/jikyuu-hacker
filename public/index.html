<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>時給ハッカー | コックピット（保存＋今日の集計）</title>
    <style>
      /* ---- Warm Cozy Theme ----
         Base:  #F7EFE7 （あたたかいアイボリー, 面積 61.8%）
         Ink:   #2F2A26 （深いカカオ）
         Accent:#E6A24B （やわらかゴールド）
      --------------------------------------*/
      :root{
        --base:#F7EFE7;
        --ink:#2F2A26;
        --muted:#7B726C;        /* 補助文字（温かめグレー） */
        --panel:#FFFFFF;        /* カード面 */
        --accent:#E6A24B;       /* 行動色（CTA） */
        --accent-ink:#1E1A18;   /* アクセント上の文字 */
        --accent-weak:#C88F46;  /* ホバー等の濃色 */
        --radius:16px;
        --shadow:0 10px 28px rgba(47,42,38,.10);
      }
      html,body{height:100%}
      body{
        margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
        color:var(--ink);
        background:
          linear-gradient(135deg,
            var(--base) 0,
            var(--base) 61.8%,
            rgba(230,162,75,0.12) 61.8%,
            rgba(230,162,75,0.12) 100%);
        display:grid; place-items:center;
      }
      .card{
        width:min(960px, 92vw);
        background:var(--panel);
        border:1px solid rgba(47,42,38,.10);
        border-radius:var(--radius);
        box-shadow:var(--shadow);
        padding:28px;
      }
      .row{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
      .grow{flex:1}
      h1{margin:0 0 4px 0; font-size:22px; letter-spacing:.2px}
      .muted{color:var(--muted); font-size:13px}

      button{
        appearance:none; border:none; border-radius:12px; padding:12px 16px;
        font-weight:700; cursor:pointer; transition:.2s transform ease, .2s filter;
        background:var(--accent); color:var(--accent-ink);
        box-shadow:0 2px 0 rgba(0,0,0,.06) inset;
      }
      button:hover{ filter:brightness(.97) }
      button:disabled{ opacity:.6; cursor:not-allowed }
      button.ghost{
        background:transparent; color:var(--ink);
        border:1px solid rgba(47,42,38,.25)
      }

      .grid{display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:16px}
      .stat{
        background:linear-gradient(180deg, #FFFFFF, #FAF6F1);
        border:1px solid rgba(47,42,38,.12);
        border-radius:12px; padding:14px
      }
      .stat .label{color:var(--muted); font-size:12px}
      .stat .val{font-size:20px; font-weight:800; margin-top:6px}

      .map{
        height:260px; border-radius:12px; margin-top:16px;
        background:
          linear-gradient(0deg, rgba(47,42,38,.06), rgba(47,42,38,.03)),
          repeating-linear-gradient(0deg, rgba(47,42,38,.10) 0 1px, transparent 1px 40px),
          repeating-linear-gradient(90deg, rgba(47,42,38,.10) 0 1px, transparent 1px 40px);
        display:grid; place-items:center; color:var(--muted);
      }
      .footer{margin-top:18px; color:var(--muted); font-size:12px; text-align:center}
      .rowbtn{display:flex; gap:10px; margin-top:14px; flex-wrap:wrap}
      .tag{
        background:rgba(230,162,75,.16); color:#6B4B1D;
        border:1px solid rgba(230,162,75,.55);
        padding:6px 10px; border-radius:999px; font-size:12px
      }
      a{color:#6B4B1D; text-decoration:none}
      a:hover{text-decoration:underline}

      /* ---- モーダル ---- */
      .modal-bg{
        position:fixed; inset:0; background:rgba(0,0,0,.2);
        display:grid; place-items:center; z-index:1000;
      }
      .modal-bg.hidden{ display:none !important; } /* ← 隠すを必ず勝たせる */
      .modal{
        background:#fff; color:var(--ink); border-radius:14px;
        width:min(420px, 92vw); padding:18px; box-shadow:var(--shadow)
      }
      .modal h3{margin:0 0 10px 0; font-size:18px}
      .field{margin:10px 0}
      .field label{font-size:12px; color:var(--muted)}
      .field input{width:100%; padding:10px 12px; border:1px solid rgba(47,42,38,.2); border-radius:10px; font-size:14px}
      .right{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}

      /* ---- トースト ---- */
      .toast{
        position:fixed; left:50%; bottom:26px; transform:translateX(-50%);
        background:#fff; border:1px solid rgba(47,42,38,.12);
        padding:10px 14px; border-radius:999px; box-shadow:var(--shadow);
        color:var(--ink); font-weight:700; z-index:1100
      }
      .hidden{display:none}
    </style>
  </head>
  <body>
    <div class="card">
      <div class="row">
        <div class="grow">
          <h1>時給ハッカー — コックピット</h1>
          <div class="muted">Googleでログイン→開始/終了で「本物の保存」。保存後は“今日の合計”に反映します。</div>
        </div>
        <div>
          <button id="signinBtn">Googleでログイン</button>
          <button id="signoutBtn" class="ghost hidden">ログアウト</button>
        </div>
      </div>

      <div id="authed" class="hidden">
        <div class="row" style="margin-top:14px">
          <img id="avatar" src="" alt="" style="width:40px;height:40px;border-radius:50%;border:1px solid rgba(47,42,38,.25)">
          <div class="grow">
            <div id="username" style="font-weight:800"></div>
            <div class="muted" id="email"></div>
          </div>
          <span class="tag">保存先：users/{uid}/work_sessions（今日の集計を表示）</span>
        </div>

        <div class="grid">
          <div class="stat"><div class="label">推定時給（今日）</div><div class="val" id="wage">¥0</div></div>
          <div class="stat"><div class="label">今日の件数</div><div class="val" id="orders">0</div></div>
          <div class="stat"><div class="label">稼働時間（今日）</div><div class="val" id="time">0:00</div></div>
        </div>

        <div class="rowbtn">
          <button id="startBtn">開始</button>
          <button id="pauseBtn" class="ghost">一時停止</button>
          <button id="stopBtn" class="ghost">終了</button>
        </div>

        <div class="map">（ここにGoogleマップを統合予定／現在はダミー表示）</div>
      </div>

      <div id="unauthed" style="margin-top:18px" class="muted">
        ログインすると、ここにコックピットが表示されます。
      </div>

      <div class="footer">© Jikyuu Hacker</div>
    </div>

    <!-- 保存用モーダル（終了時） -->
    <div id="endModal" class="modal-bg hidden" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="saveTitle">
        <h3 id="saveTitle">セッションを保存</h3>
        <div class="field">
          <label>売上（円）</label>
          <input id="inputSales" type="number" min="0" step="100" placeholder="例: 3500" />
        </div>
        <div class="field">
          <label>件数</label>
          <input id="inputOrders" type="number" min="0" step="1" placeholder="例: 5" />
        </div>
        <div class="right">
          <button id="cancelSave" class="ghost" type="button">キャンセル</button>
          <button id="confirmSave" type="button">保存</button>
        </div>
      </div>
    </div>

    <!-- 保存トースト -->
    <div id="toast" class="toast hidden">保存しました ✅</div>

    <!-- Firebase (Modules via CDN) -->
    <script type="module">
      // --- Firebase 設定（あなたの値をそのまま使用） ---
      const firebaseConfig = {
        apiKey: "AIzaSyA8x75S7gx0vF4CtENATZO0Spnn33t_Oyg",
        authDomain: "jikyuu-hacker.firebaseapp.com",
        projectId: "jikyuu-hacker",
        storageBucket: "jikyuu-hacker.firebasestorage.app",
        messagingSenderId: "141311985365",
        appId: "1:141311985365:web:41f64d51bcc7737d5c445c",
        measurementId: "G-B85Q3TRR6V"
      };

      /* v11.0.1 で統一 */
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        initializeAuth,
        indexedDBLocalPersistence,
        browserLocalPersistence,
        browserPopupRedirectResolver,
        GoogleAuthProvider,
        onAuthStateChanged,
        signInWithPopup,
        signInWithRedirect,
        signOut
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
      import {
        getFirestore, collection, addDoc, updateDoc, serverTimestamp,
        query, where, orderBy, limit, onSnapshot, Timestamp
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";

      // --- 初期化 ---
      const app = initializeApp(firebaseConfig);
      try { getAnalytics(app); } catch (_) {}

      // Auth（明示初期化）
      const auth = initializeAuth(app, {
        persistence: [indexedDBLocalPersistence, browserLocalPersistence],
        popupRedirectResolver: browserPopupRedirectResolver
      });
      auth.languageCode = "ja";
      const provider = new GoogleAuthProvider();

      // Firestore
      const db = getFirestore(app);

      // DOM util
      const $   = (id)=>document.getElementById(id);
      const show= (el)=>{ el.classList.remove("hidden"); el.setAttribute("aria-hidden","false"); };
      const hide= (el)=>{ el.classList.add("hidden");    el.setAttribute("aria-hidden","true");  };

      // 初期状態でモーダルは必ず閉じる
      hide($("endModal"));

      // ユーティリティ
      const pad2 = (n)=>String(n).padStart(2,"0");
      const fmtHMM = (sec)=>{
        const h = Math.floor(sec/3600);
        const m = Math.floor((sec%3600)/60);
        return `${h>0? h+":" : ""}${h>0? pad2(m): m.toString().padStart(1,"0")}:${pad2(Math.floor(sec%60))}`.replace(/^0:/,"0:");
      };

      // UI状態
      let signingIn = false;
      let timerId = null, seconds = 0, earned = 0, orders = 0;
      let currentSessionRef = null;  // Firestore Doc参照
      let startedAtMs = null;        // クライアント計測用
      let unsubscribeToday = null;   // 今日の集計リスナー

      // クリック連打ガード＋Redirectフォールバック
      $("signinBtn").addEventListener("click", async ()=>{
        if (signingIn) return;
        signingIn = true; $("signinBtn").disabled = true; $("signinBtn").style.opacity = ".7";
        try {
          await signInWithPopup(auth, provider);
        } catch(e) {
          const msg = String(e?.message || "");
          if (e?.code === "auth/popup-blocked" || msg.includes("Pending promise")){
            await signInWithRedirect(auth, provider);
          } else {
            alert("ログインに失敗しました: " + (e?.message || e));
          }
        } finally {
          signingIn = false; $("signinBtn").disabled = false; $("signinBtn").style.opacity = "";
        }
      });
      $("signoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

      // タイマー（見た目の推定）
      function tick(){
        seconds += 5; // デモ用 5秒刻み
        $("time").textContent = fmtHMM(seconds);
        $("wage").textContent = `¥${(seconds? Math.round((earned/(seconds/3600))) : 0).toLocaleString()}`;
        $("orders").textContent = String(orders);
      }

      $("startBtn").addEventListener("click", async ()=>{
        if (!auth.currentUser) { alert("先にログインしてください"); return; }
        if (timerId || currentSessionRef) return;

        // Firestore にセッション作成
        const uid = auth.currentUser.uid;
        const col = collection(db, "users", uid, "work_sessions");
        currentSessionRef = await addDoc(col, {
          status: "running",
          startTime: serverTimestamp(),
          endTime: null,
          ordersCount: 0,
          grossSales: 0,
          areaGeohash: null,
          areaLabel: null,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });
        startedAtMs = Date.now();

        // UI開始
        timerId = setInterval(tick, 5000);
      });

      $("pauseBtn").addEventListener("click", ()=>{
        if (timerId){ clearInterval(timerId); timerId=null; }
      });

      // 終了→入力モーダル表示
      $("stopBtn").addEventListener("click", ()=>{
        if (!auth.currentUser) { alert("先にログインしてください"); return; }
        if (!currentSessionRef){ alert("まだ開始していません"); return; }
        show($("endModal"));
        $("inputSales").focus();
      });

      // モーダル制御：外側クリック・Esc・キャンセルで閉じる
      $("endModal").addEventListener("click", (e)=>{
        if (e.target.id === "endModal") hide($("endModal"));
      });
      document.addEventListener("keydown", (e)=>{
        if (e.key === "Escape") hide($("endModal"));
      });
      $("cancelSave").addEventListener("click", ()=> hide($("endModal")));

      $("confirmSave").addEventListener("click", async ()=>{
        if (!auth.currentUser){ alert("ログインが必要です"); hide($("endModal")); return; }
        if (!currentSessionRef){ alert("セッションが見つかりません。もう一度開始してください"); hide($("endModal")); return; }

        const sales = Number($("inputSales").value || 0);
        const cnt   = Number($("inputOrders").value || 0);
        if (!Number.isFinite(sales) || sales < 0 || !Number.isFinite(cnt) || cnt < 0){
          alert("数値を正しく入力してください"); return;
        }

        earned = sales; orders = cnt;

        // Firestore 更新
        const durationSec = Math.max(1, Math.round((Date.now() - (startedAtMs||Date.now()))/1000));
        const hours = durationSec / 3600;
        const hourly = hours > 0 ? Math.round(sales / hours) : 0;

        try{
          await updateDoc(currentSessionRef, {
            status: "ended",
            endTime: serverTimestamp(),
            ordersCount: cnt,
            grossSales: sales,
            durationSec,
            hourlyWage: hourly,
            updatedAt: serverTimestamp()
          });
        }catch(err){
          alert("保存に失敗しました: " + (err?.message || err));
          return;
        }finally{
          hide($("endModal"));
          // トースト表示
          const t = $("toast"); t.classList.remove("hidden");
          setTimeout(()=> t.classList.add("hidden"), 1800);
        }

        // 片付け（見た目のカウンタは“今日の集計”に任せる）
        if (timerId){ clearInterval(timerId); timerId=null; }
        seconds = 0; earned = 0; orders = 0;
        currentSessionRef = null; startedAtMs = null;
      });

      // ---- 今日の集計（リアルタイム） ----
      function startTodayListener(uid){
        // すでに購読中なら解除
        if (unsubscribeToday){ unsubscribeToday(); unsubscribeToday = null; }

        const startOfDay = new Date();
        startOfDay.setHours(0,0,0,0);
        const startTs = Timestamp.fromDate(startOfDay);

        // 端末差やインデックス不要のため、まずは「status=ended の最近50件」を購読 → クライアントで“今日”にフィルタ
        const col = collection(db, "users", uid, "work_sessions");
        const q = query(col, where("status","==","ended"), orderBy("startTime","desc"), limit(50));

        unsubscribeToday = onSnapshot(q, (snap)=>{
          let totalSales = 0, totalOrders = 0, totalSec = 0;
          snap.forEach(doc=>{
            const d = doc.data();
            if (!d.startTime) return;
            if (d.startTime.toMillis() < startTs.toMillis()) return; // 今日以前は除外
            totalSales  += Number(d.grossSales || 0);
            totalOrders += Number(d.ordersCount || 0);
            totalSec    += Number(d.durationSec || 0);
          });
          const hourly = totalSec>0 ? Math.round(totalSales / (totalSec/3600)) : 0;
          $("wage").textContent   = `¥${hourly.toLocaleString()}`;
          $("orders").textContent = String(totalOrders);
          const h = Math.floor(totalSec/3600), m = Math.floor((totalSec%3600)/60);
          $("time").textContent   = `${h}:${String(m).padStart(2,"0")}`;
        }, (err)=>{
          console.error("today onSnapshot error:", err);
        });
      }

      onAuthStateChanged(auth, (user)=>{
        if (user){
          $("username").textContent = user.displayName || "配達員さん";
          $("email").textContent    = user.email || "";
          $("avatar").src           = user.photoURL || "";
          show($("authed")); show($("signoutBtn")); hide($("signinBtn")); hide($("unauthed"));
          startTodayListener(user.uid);
        } else {
          hide($("endModal")); // ログアウト時はモーダルも必ず閉じる
          hide($("authed")); hide($("signoutBtn")); show($("signinBtn")); show($("unauthed"));
          if (unsubscribeToday){ unsubscribeToday(); unsubscribeToday = null; }
          if (timerId){ clearInterval(timerId); timerId=null; }
          seconds=0; earned=0; orders=0; startedAtMs=null; currentSessionRef=null;
          $("time").textContent="0:00"; $("wage").textContent="¥0"; $("orders").textContent="0";
        }
      });
    </script>
  </body>
</html>
