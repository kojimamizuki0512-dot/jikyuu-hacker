<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>時給ハッカー | Atelier White & Mauve + HACOBIT Hero</title>
    <meta name="color-scheme" content="light only" />
    <style>
      /* ===== Brand palette (Atelier White & Mauve) ===== */
      :root{
        --base:#F6F4F2; --ink:#413D4B; --ink-weak:#6D6877;
        --primary:#A18291; --primary-strong:#8C6F7D; --accent:#B58A6C;
        --radius-lg:22px; --radius:14px;
        --shadow-lg:0 24px 60px rgba(65,61,75,.12), 0 2px 10px rgba(65,61,75,.04);
        --shadow-sm:0 8px 24px rgba(65,61,75,.10);
        --safe-bottom: env(safe-area-inset-bottom, 0px);
      }
      html,body{height:100%}
      body{
        margin:0; color:var(--ink);
        font-family: ui-rounded, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
        background:
          radial-gradient(1200px 800px at 15% 10%, rgba(181,138,108,.10), transparent 60%),
          radial-gradient(1400px 900px at 85% 20%, rgba(161,130,145,.12), transparent 60%),
          linear-gradient(135deg, var(--base) 0 61.8%, rgba(161,130,145,.10) 61.8% 100%);
        display:grid; place-items:center;
      }
      .app{
        width:min(1100px, 94vw);
        border-radius:var(--radius-lg);
        box-shadow:var(--shadow-lg);
        background:linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.60));
        backdrop-filter:saturate(1.2) blur(10px);
        -webkit-backdrop-filter:saturate(1.2) blur(10px);
        border:1px solid rgba(65,61,75,.08); overflow:hidden;
      }

      /* ===== Header ===== */
      .header{
        display:flex; align-items:center; gap:14px; padding:18px 22px;
        border-bottom:1px solid rgba(65,61,75,.06);
        background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.65));
      }
      .logo{width:40px;height:40px;border-radius:12px;background:
        radial-gradient(60% 60% at 30% 30%, rgba(255,255,255,.65), transparent 60%),
        linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); box-shadow:var(--shadow-sm)}
      .ttl{font-weight:900; letter-spacing:.3px}
      .sub{color:var(--ink-weak); font-size:13px}
      .spacer{flex:1}
      .ghost{background:transparent; color:var(--ink); border:1px solid rgba(65,61,75,.20); border-radius:999px; padding:10px 14px; font-weight:700; cursor:pointer}
      .btn{appearance:none;border:none;border-radius:999px;background:linear-gradient(180deg, var(--primary) 0%, var(--primary-strong) 100%);
        color:#FFF;padding:12px 18px;font-weight:800;letter-spacing:.2px;box-shadow:0 6px 14px rgba(161,130,145,.35), inset 0 2px 0 rgba(255,255,255,.25);
        transform:translateY(0);transition:.15s transform ease,.2s filter ease;cursor:pointer;touch-action:manipulation}
      .btn:hover{filter:brightness(1.03)} .btn:active{transform:translateY(2px)}

      /* ===== Hero: big HACOBIT always visible ===== */
      .hero{display:grid; grid-template-columns:1.2fr .8fr; gap:16px; align-items:center; padding:18px 22px 10px}
      .hero-left{
        background:linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.62));
        border:1px solid rgba(65,61,75,.08); border-radius:18px; padding:16px; box-shadow:var(--shadow-sm)
      }
      .hero-left h1{margin:0 0 6px 0; font-size:20px}
      .micro{color:var(--ink-weak); font-size:13px}
      .hero-right{position:relative; display:grid; place-items:center}
      .hero-wrap{width:min(320px, 72vw); aspect-ratio:1; position:relative}
      /* ブロンズきらめき（クエスト/新記録時） */
      .sparkles{pointer-events:none; position:absolute; inset:0}
      .sparkles span{
        position:absolute; width:8px;height:8px; background:var(--accent); border-radius:2px; opacity:0;
      }
      @keyframes sparkle{
        0%{transform:translate(0,0) scale(1) rotate(0deg); opacity:.9}
        100%{transform:translate(var(--dx),var(--dy)) scale(0.8) rotate(180deg); opacity:0}
      }
      .celebrate .sparkles span{ animation: sparkle .9s ease-out forwards }

      /* HACOBIT SVG（線= #413D4B 2.5px, base主体, 小面積アクセント, 影12%） */
      .hb-svg{width:100%; height:100%}
      /* idle: gentle breathing（常時） */
      @keyframes hb_idle_bob{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-2px)} }
      #hbHero.idle #hb_body{ animation: hb_idle_bob 3s ease-in-out infinite; }
      /* random blink（JSでトグル） */
      @keyframes hb_blink{ from{transform:scaleY(1)} to{transform:scaleY(.7)} }
      #hbHero.blink #hb_eyes{ animation: hb_blink .12s linear both; }

      /* success pose（1.0s） */
      #hbHero.play #hb_body{animation:hb_body_up .12s ease-out both, hb_body_relax .24s .60s ease-in-out both, hb_body_return .16s .84s linear both}
      @keyframes hb_body_up{from{transform:translateY(0)} to{transform:translateY(-4px)}}
      @keyframes hb_body_relax{from{transform:translateY(-4px)} to{transform:translateY(-2px)}}
      @keyframes hb_body_return{from{transform:translateY(-2px)} to{transform:translateY(0)}}
      #hbHero.play #hb_armR{transform-origin: 280px 260px; animation:hb_arm_raise .16s .12s ease-out both}
      @keyframes hb_arm_raise{from{transform:rotate(0deg) translate(0,0)} to{transform:rotate(12deg) translate(6px,-2px)}}
      #hbHero.play #hb_scarf{transform-origin: 256px 300px; animation:hb_scarf_follow .16s .20s cubic-bezier(.34,1.56,.64,1) both}
      @keyframes hb_scarf_follow{0%{transform:rotate(0deg)}70%{transform:rotate(6deg)}100%{transform:rotate(-3deg)}}

      /* ===== Profile / Dashboard ===== */
      .profile{display:flex; align-items:center; gap:12px; padding:0 22px 12px}
      .avatar{width:44px;height:44px;border-radius:50%;border:1px solid rgba(65,61,75,.15)}
      .tag{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(181,138,108,.45);background:rgba(181,138,108,.12);color:var(--accent);border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
      .grid{display:grid; grid-template-columns:repeat(3,1fr); gap:14px; padding:0 22px}
      .card{background:
        linear-gradient(180deg, rgba(255,255,255,.92), rgba(255,255,255,.70)),
        radial-gradient(100% 140% at 100% 0, rgba(181,138,108,.10), transparent 35%),
        radial-gradient(100% 140% at 0 100%, rgba(161,130,145,.08), transparent 35%);
        border:1px solid rgba(65,61,75,.08); border-radius:16px; padding:14px; box-shadow:var(--shadow-sm)}
      .label{font-size:12px; color:var(--ink-weak)}
      .value{font-size:22px; font-weight:900; letter-spacing:.2px; margin-top:6px}
      .actions{display:flex; gap:10px; padding:10px 22px 16px}
      .chip{border:1px solid rgba(65,61,75,.18); background:rgba(255,255,255,.6); padding:12px 16px; border-radius:14px; font-weight:800; color:var(--ink); cursor:pointer; transition:.15s transform ease; touch-action:manipulation; min-width:48px; min-height:44px}
      .chip:active{transform:translateY(2px)}
      .chip.primary{border-color:transparent;background:linear-gradient(180deg, var(--primary) 0%, var(--primary-strong) 100%); color:#fff; box-shadow:0 6px 14px rgba(161,130,145,.35), inset 0 2px 0 rgba(255,255,255,.20)}

      /* ===== Board（空状態イラスト対応） ===== */
      .board{margin:4px 22px 22px; height:280px; border-radius:18px; background:
        linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.7)),
        repeating-linear-gradient(0deg, rgba(65,61,75,.08) 0 1px, transparent 1px 48px),
        repeating-linear-gradient(90deg, rgba(65,61,75,.08) 0 1px, transparent 1px 48px);
        border:1px solid rgba(65,61,75,.08); box-shadow:var(--shadow-sm); position:relative; overflow:hidden; color:var(--ink-weak); display:grid; place-items:center}
      .empty{display:grid; place-items:center; gap:10px}
      .hidden{display:none !important}

      /* ===== Toast（テキストのみ） ===== */
      .toast{position:fixed; left:50%; bottom:calc(22px + var(--safe-bottom)); transform:translateX(-50%); background:linear-gradient(180deg, #fff, rgba(255,255,255,.92)); border:1px solid rgba(65,61,75,.10); color:var(--ink); font-weight:800; padding:10px 14px; border-radius:999px; box-shadow:var(--shadow-sm); z-index:1200}

      /* ===== Modal ===== */
      .modal-bg{position:fixed; inset:0; z-index:1100; display:grid; place-items:center; background:rgba(65,61,75,.18)}
      .modal{width:min(440px, 92vw); background:linear-gradient(180deg, #fff, rgba(255,255,255,.94)); border:1px solid rgba(65,61,75,.12); border-radius:18px; padding:18px; box-shadow:var(--shadow-lg)}
      .modal h3{margin:0 0 10px 0} .field{margin:10px 0} .field label{font-size:12px; color:var(--ink-weak)}
      .field input{width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(65,61,75,.18); background:rgba(255,255,255,.8); color:var(--ink)}
      .right{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}

      /* ===== Loader overlay ===== */
      .loader{position:fixed; inset:0; background:rgba(246,244,242,.75); display:grid; place-items:center; z-index:1400}
      .loader-box{display:grid; place-items:center; gap:10px; padding:18px; border-radius:16px; background:linear-gradient(180deg,#fff,rgba(255,255,255,.92)); border:1px solid rgba(65,61,75,.12); box-shadow:var(--shadow-sm)}
      .ring{width:38px;height:38px;border:3px solid rgba(65,61,75,.15); border-top-color:var(--primary); border-radius:50%; animation:spin 1s linear infinite}
      @keyframes spin{to{transform:rotate(360deg)}}

      /* ===== Mobile ===== */
      @media (max-width:900px){ .hero{grid-template-columns:1fr; gap:10px} .hero-right{order:-1} }
      @media (max-width:720px){
        .grid{grid-template-columns:1fr; gap:10px}
        .actions{display:none} /* PCのみ。モバイルは下部バーへ集約 */
      }
      .mbar{position:fixed; left:0; right:0; bottom:0; padding:8px 10px calc(8px + var(--safe-bottom)); background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.98)); border-top:1px solid rgba(65,61,75,.10); display:none; gap:10px; justify-content:center; z-index:1200; backdrop-filter:blur(8px)}
      .mbar .mbtn{flex:1; min-height:48px; border-radius:14px; font-weight:900; letter-spacing:.2px; touch-action:manipulation; border:1px solid rgba(65,61,75,.18); background:#fff; color:var(--ink)}
      .mbar .mbtn.primary{border:none; background:linear-gradient(180deg, var(--primary) 0%, var(--primary-strong) 100%); color:#fff; box-shadow:0 6px 14px rgba(161,130,145,.30), inset 0 2px 0 rgba(255,255,255,.20)}
      @media (max-width:720px){ .mbar{display:flex} }

      /* gentle enters */
      @media (prefers-reduced-motion: no-preference){
        .hero-left,.card,.board{animation:floatUp .28s ease both}
        @keyframes floatUp{from{opacity:0; transform:translateY(4px)} to{opacity:1; transform:translateY(0)}}
      }
      @media (prefers-reduced-motion: reduce){
        #hbHero.idle #hb_body, #hbHero.blink #hb_eyes, #hbHero.play #hb_body, #hbHero.play #hb_armR, #hbHero.play #hb_scarf { animation:none !important; }
      }
    </style>
  </head>
  <body>
    <div id="loader" class="loader">
      <div class="loader-box">
        <div class="ring" aria-hidden="true"></div>
        <div style="font-weight:800;color:var(--ink)">読み込み中…少し待ってね。</div>
      </div>
    </div>

    <div class="app" role="application" aria-label="時給ハッカー コックピット">
      <!-- Header -->
      <div class="header">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="ttl">時給ハッカー</div>
          <div class="sub">創造的で、上質な「頼れるパートナー」</div>
        </div>
        <div class="spacer"></div>
        <button id="signinBtn" class="btn">Googleでログイン</button>
        <button id="signoutBtn" class="ghost hidden">ログアウト</button>
      </div>

      <!-- Hero with big HACOBIT -->
      <section class="hero" aria-label="ヒーロー">
        <div class="hero-left">
          <h1>HACOBIT が相棒。今日は軽やかにいこう。</h1>
          <p class="micro">「開始」でタイマー、「終了」で売上と件数をさっと記録。保存すると、今日の合計がすぐに反映されるよ。</p>
        </div>
        <div class="hero-right">
          <div id="heroWrap" class="hero-wrap">
            <!-- sparkles (12個) -->
            <div class="sparkles" aria-hidden="true">
              <!-- 位置はCSS変数で飛ばす -->
              <span style="left:50%;top:8%; --dx:-40px; --dy:-40px"></span>
              <span style="left:18%;top:22%; --dx:-30px; --dy:-20px"></span>
              <span style="left:82%;top:28%; --dx:30px; --dy:-24px"></span>
              <span style="left:12%;top:54%; --dx:-26px; --dy:6px"></span>
              <span style="left:88%;top:58%; --dx:26px; --dy:10px"></span>
              <span style="left:28%;top:82%; --dx:-8px; --dy:26px"></span>
              <span style="left:72%;top:82%; --dx:8px; --dy:26px"></span>
              <span style="left:48%;top:92%; --dx:0; --dy:30px"></span>
              <span style="left:6%;top:36%; --dx:-18px; --dy:-6px"></span>
              <span style="left:94%;top:36%; --dx:18px; --dy:-6px"></span>
              <span style="left:34%;top:10%; --dx:-14px; --dy:-24px"></span>
              <span style="left:66%;top:10%; --dx:14px; --dy:-24px"></span>
            </div>

            <!-- HACOBIT inline SVG -->
            <svg id="hbHero" class="hb-svg idle" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg" aria-label="HACOBIT">
              <defs>
                <filter id="hbShadow" x="-50%" y="-50%" width="200%" height="200%">
                  <feOffset dx="0" dy="1.5" in="SourceAlpha" result="off"/>
                  <feGaussianBlur in="off" stdDeviation="4" result="blur"/>
                  <feComponentTransfer in="blur" result="shadow"><feFuncA type="linear" slope="0.12"/></feComponentTransfer>
                  <feMerge><feMergeNode in="shadow"/><feMergeNode in="SourceGraphic"/></feMerge>
                </filter>
              </defs>
              <g id="hb_group" filter="url(#hbShadow)" stroke="#413D4B" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <!-- body -->
                <g id="hb_body">
                  <rect x="176" y="180" rx="24" ry="24" width="160" height="160" fill="#F6F4F2"/>
                  <!-- left arm -->
                  <path d="M176 230 C 150 240, 150 280, 176 292" fill="none"/>
                </g>
                <!-- right arm -->
                <g id="hb_armR">
                  <path d="M336 230 C 362 240, 362 280, 336 292" fill="none"/>
                </g>
                <!-- scarf -->
                <g id="hb_scarf">
                  <path d="M256 300 C 276 296, 296 296, 312 302" fill="none" stroke="#A18291"/>
                  <path d="M312 302 C 318 305, 320 312, 314 318" fill="none" stroke="#B58A6C"/>
                </g>
                <!-- face -->
                <g id="hb_eyes">
                  <circle cx="228" cy="240" r="6" fill="#413D4B"/>
                  <circle cx="284" cy="240" r="6" fill="#413D4B"/>
                  <path d="M230 265 h20" stroke="#413D4B"/>
                </g>
                <rect x="248" y="332" width="16" height="12" rx="2" fill="#B58A6C"/>
              </g>
            </svg>
          </div>
        </div>
      </section>

      <!-- Profile -->
      <div id="authed" class="profile hidden">
        <img id="avatar" class="avatar" alt="ユーザーのアバター" src="">
        <div class="grow">
          <div id="username" style="font-weight:900"></div>
          <div id="email" class="sub"></div>
        </div>
        <span class="tag" title="保存コレクション">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M5 12h14M12 5v14" stroke="#B58A6C" stroke-width="2" stroke-linecap="round"/></svg>
          users/{uid}/work_sessions
        </span>
      </div>

      <!-- Dashboard -->
      <div class="grid" aria-live="polite">
        <div class="card"><div class="label">推定時給（今日）</div><div id="wage" class="value">¥0</div></div>
        <div class="card"><div class="label">今日の件数</div><div id="orders" class="value">0</div></div>
        <div class="card"><div class="label">稼働時間（今日）</div><div id="time" class="value">0:00</div></div>
      </div>

      <!-- Actions (PC) -->
      <div class="actions">
        <button id="startBtn" class="chip primary">開始する</button>
        <button id="pauseBtn" class="chip">一時停止</button>
        <button id="stopBtn" class="chip">終了して記録</button>
        <div class="spacer"></div>
        <span class="micro">クエストは準備中</span>
      </div>

      <!-- Board（空状態をHACOBITで表示） -->
      <div class="board">
        <div id="empty" class="empty hidden">
          <svg width="72" height="72" viewBox="0 0 72 72" fill="none" aria-hidden="true">
            <rect x="14" y="20" width="44" height="32" rx="8" fill="#F6F4F2" stroke="#413D4B" stroke-width="2.5"/>
            <circle cx="28" cy="34" r="2" fill="#413D4B"/><circle cx="44" cy="34" r="2" fill="#413D4B"/>
            <path d="M30 44 h12" stroke="#413D4B" stroke-width="2.5" stroke-linecap="round"/>
            <path d="M36 52 l10 6" stroke="#A18291" stroke-width="2.5" stroke-linecap="round"/>
            <rect x="34" y="48" width="4" height="4" rx="1" fill="#B58A6C"/>
          </svg>
          <div class="micro">まだ記録がありません。まずは「開始」してみよう。</div>
        </div>
        <div id="boardHint" class="micro">（ここにGoogleマップ / アクティビティを重ねて表示予定）</div>
      </div>
    </div>

    <!-- Mobile bottom action bar -->
    <div class="mbar" role="toolbar" aria-label="操作バー（モバイル）">
      <button id="mStart" class="mbtn primary">開始</button>
      <button id="mPause" class="mbtn">一時停止</button>
      <button id="mStop"  class="mbtn">終了</button>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast hidden" role="status" aria-live="polite">保存しました。今日もいい流れ！</div>

    <script type="module">
      /* ===== Firebase ===== */
      const firebaseConfig = {
        apiKey: "AIzaSyA8x75S7gx0vF4CtENATZO0Spnn33t_Oyg",
        authDomain: "jikyuu-hacker.firebaseapp.com",
        projectId: "jikyuu-hacker",
        storageBucket: "jikyuu-hacker.firebasestorage.app",
        messagingSenderId: "141311985365",
        appId: "1:141311985365:web:41f64d51bcc7737d5c445c",
        measurementId: "G-B85Q3TRR6V"
      };
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import { initializeAuth, indexedDBLocalPersistence, browserLocalPersistence, browserPopupRedirectResolver, GoogleAuthProvider, onAuthStateChanged, signInWithPopup, signInWithRedirect, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
      import { getFirestore, collection, addDoc, updateDoc, serverTimestamp, query, where, orderBy, limit, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-analytics.js";

      const app = initializeApp(firebaseConfig);
      try{ getAnalytics(app); }catch(_){}
      const auth = initializeAuth(app, {persistence:[indexedDBLocalPersistence, browserLocalPersistence], popupRedirectResolver: browserPopupRedirectResolver});
      auth.languageCode = "ja";
      const provider = new GoogleAuthProvider();
      const db = getFirestore(app);

      /* ===== DOM utils ===== */
      const $ = (id)=>document.getElementById(id);
      const show = (el)=>{ el.classList.remove("hidden"); el.setAttribute("aria-hidden","false"); };
      const hide = (el)=>{ el.classList.add("hidden"); el.setAttribute("aria-hidden","true"); };
      const pad2=(n)=>String(n).padStart(2,"0");
      const fmtHMM=(sec)=>{const h=Math.floor(sec/3600),m=Math.floor((sec%3600)/60);return `${h}:${pad2(m)}`;}

      /* ===== States ===== */
      let signingIn=false,timerId=null,seconds=0,earned=0,orders=0,currentSessionRef=null,startedAtMs=null,unsubscribeToday=null,firstLoaded=false;

      /* ===== Mascot controls ===== */
      const hb = $("hbHero");
      const heroWrap = $("heroWrap");
      function blinkLoop(){
        const next = 3500 + Math.random()*2500;
        setTimeout(()=>{ hb.classList.add("blink"); void hb.offsetWidth; hb.classList.remove("blink"); blinkLoop(); }, next);
      }
      blinkLoop();
      const celebrate = ()=>{
        heroWrap.classList.add("celebrate");
        hb.classList.remove("play"); void hb.offsetWidth; hb.classList.add("play");
        setTimeout(()=> heroWrap.classList.remove("celebrate"), 1000);
      };

      /* ===== Toast helper ===== */
      const toast = (msg)=>{ const t=$("toast"); t.textContent=msg; t.classList.remove("hidden"); setTimeout(()=>t.classList.add("hidden"), 1800); };

      /* ===== Auth buttons ===== */
      $("signinBtn").addEventListener("click", async ()=>{
        if(signingIn) return; signingIn=true; $("signinBtn").disabled=true;
        try{ await signInWithPopup(auth, provider); }
        catch(e){ const msg=String(e?.message||""); if(e?.code==="auth/popup-blocked"||msg.includes("Pending promise")) await signInWithRedirect(auth, provider); else alert("ログインに失敗しました: "+(e?.message||e)); }
        finally{ signingIn=false; $("signinBtn").disabled=false; }
      });
      $("signoutBtn").addEventListener("click", async ()=>{ await signOut(auth); });

      /* ===== Timer visual ===== */
      function tick(){ seconds+=5; $("time").textContent=fmtHMM(seconds); $("wage").textContent=`¥${(seconds? Math.round((earned/(seconds/3600))):0).toLocaleString()}`; $("orders").textContent=String(orders); }

      async function startSession(){
        if(!auth.currentUser){ alert("先にログインしてね"); return; }
        if(timerId||currentSessionRef) return;
        const uid=auth.currentUser.uid;
        const col=collection(db,"users",uid,"work_sessions");
        currentSessionRef=await addDoc(col,{status:"running", startTime:serverTimestamp(), endTime:null, ordersCount:0, grossSales:0, areaGeohash:null, areaLabel:null, createdAt:serverTimestamp(), updatedAt:serverTimestamp()});
        startedAtMs=Date.now(); timerId=setInterval(tick,5000);
        toast("タイマー開始。いい感じ！"); celebrate();
      }
      function pauseSession(){ if(timerId){ clearInterval(timerId); timerId=null; toast("一時停止中。水分補給してね"); } }
      function requestEnd(){ if(!auth.currentUser){ alert("先にログインしてね"); return; } if(!currentSessionRef){ alert("まずは開始しよう"); return; } show($("endModal")); $("inputSales").focus(); }

      /* PC & Mobile actions */
      $("startBtn").addEventListener("click", startSession);
      $("pauseBtn").addEventListener("click", pauseSession);
      $("stopBtn").addEventListener("click", requestEnd);
      $("mStart").addEventListener("click", startSession);
      $("mPause").addEventListener("click", pauseSession);
      $("mStop").addEventListener("click", requestEnd);

      /* ===== Modal ===== */
      $("endModal").addEventListener("click",(e)=>{ if(e.target.id==="endModal") hide($("endModal")); });
      document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") hide($("endModal")); });
      $("cancelSave").addEventListener("click",()=> hide($("endModal")));

      $("confirmSave").addEventListener("click", async ()=>{
        if(!auth.currentUser){ hide($("endModal")); return; }
        if(!currentSessionRef){ hide($("endModal")); return; }
        const sales=Number($("inputSales").value||0), cnt=Number($("inputOrders").value||0);
        if(!Number.isFinite(sales)||sales<0||!Number.isFinite(cnt)||cnt<0){ alert("数値を正しく入力してね"); return; }
        earned=sales; orders=cnt;
        const durationSec=Math.max(1, Math.round((Date.now()-(startedAtMs||Date.now()))/1000));
        const hours=durationSec/3600; const hourly=hours>0? Math.round(sales/hours):0;
        try{
          await updateDoc(currentSessionRef,{status:"ended", endTime:serverTimestamp(), ordersCount:cnt, grossSales:sales, durationSec, hourlyWage:hourly, updatedAt:serverTimestamp()});
          const best=Number(localStorage.getItem("bestHourly")||0);
          if(hourly>best){ localStorage.setItem("bestHourly", String(hourly)); toast("すごい！新記録！"); celebrate(); }
          else{ toast("保存しました。おつかれさま！"); celebrate(); }
        }catch(err){ alert("保存に失敗しました: "+(err?.message||err)); }
        finally{ hide($("endModal")); }
        if(timerId){ clearInterval(timerId); timerId=null; }
        seconds=0; earned=0; orders=0; currentSessionRef=null; startedAtMs=null;
      });

      /* ===== Realtime 'today' totals + empty state ===== */
      function startTodayListener(uid){
        if(unsubscribeToday){ unsubscribeToday(); unsubscribeToday=null; }
        const startOfDay=new Date(); startOfDay.setHours(0,0,0,0);
        const startTs=Timestamp.fromDate(startOfDay);
        const col=collection(db,"users",uid,"work_sessions");
        const q=query(col, where("status","==","ended"), orderBy("startTime","desc"), limit(50));
        unsubscribeToday = onSnapshot(q,(snap)=>{
          let totalSales=0,totalOrders=0,totalSec=0, count=0;
          snap.forEach(d=>{ const v=d.data(); if(!v.startTime) return; if(v.startTime.toMillis()<startTs.toMillis()) return; count++; totalSales+=Number(v.grossSales||0); totalOrders+=Number(v.ordersCount||0); totalSec+=Number(v.durationSec||0); });
          const hourly= totalSec>0 ? Math.round(totalSales/(totalSec/3600)) : 0;
          $("wage").textContent=`¥${hourly.toLocaleString()}`; $("orders").textContent=String(totalOrders); $("time").textContent=fmtHMM(totalSec);
          if(count===0){ show($("empty")); } else { hide($("empty")); }
          if(!firstLoaded){ firstLoaded=true; hide($("loader")); }
        },(err)=>{ console.error("today-snapshot",err); if(!firstLoaded){ firstLoaded=true; hide($("loader")); }});
      }

      /* ===== onAuth ===== */
      onAuthStateChanged(auth,(user)=>{
        if(user){
          $("username").textContent=user.displayName || "配達員さん"; $("email").textContent=user.email || ""; $("avatar").src=user.photoURL || "";
          show($("authed")); show($("signoutBtn")); hide($("signinBtn")); startTodayListener(user.uid);
        }else{
          hide($("authed")); hide($("signoutBtn")); show($("signinBtn"));
          if(unsubscribeToday){ unsubscribeToday(); unsubscribeToday=null; }
          if(timerId){ clearInterval(timerId); timerId=null; }
          seconds=0; earned=0; orders=0; currentSessionRef=null; startedAtMs=null;
          $("wage").textContent="¥0"; $("orders").textContent="0"; $("time").textContent="0:00";
          show($("empty"));
          if(!firstLoaded){ firstLoaded=true; hide($("loader")); }
        }
      });
    </script>
  </body>
</html>
